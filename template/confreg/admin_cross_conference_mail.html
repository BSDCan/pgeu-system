{%extends "confreg/confadmin_base.html" %}
{%block title%}Conference emails{%endblock%}
{%block extrahead%}
<script type="text/javascript" src="/media/js/selectize.min.js"></script>
<link rel="stylesheet" href="/media/css/selectize.css" />
<link rel="stylesheet" href="/media/css/selectize.default.css" />
<style>
table.mailform tr {
   vertical-align: top;
}
table.mailform input[type=text],textarea,select {
   width: 500px;
}
.selectize-control { display: inline-block; }
</style>
<script type="text/javascript">
var maxused = {'include': 0, 'exclude': 0};
var conferences = [{%for c in conferences%}
 {id: {{c.id}}, title: '{{c}}'},{%endfor%}
];
function add_conference_picker(type, default_conf, default_filt) {
   var num = maxused[type];
   maxused[type]++;

   var sel = $('<select style="width: 200px" class="noexpand" id="' + type + '_' + num + '">');
   var sel2 = $('<select class="noexpand" style="width: 300px" id="' + type + 't_' + num +'">');
   var el = $('<div id="' + type + 'wrap_' + num + '">').append(
      sel,
      sel2,
      $('<button class="btn btn-xs" style="float:right" onclick="return removeFilter(\'' + type + '\',' + num + ')"><span class="glyphicon glyphicon-remove-sign"></span></button>'),
      );
   $('#' + type + '_btn').before(el);

   var current_default_filt = default_filt;

   sel.selectize({valueField: 'id', labelField: 'title'});
   sel2.selectize({valueField: 'id', labelField: 'title'});

   var filtersel = sel2[0].selectize;
   if (!default_conf) {
      filtersel.$wrapper.hide();
   }

   sel[0].selectize.load(function(callback) {
	callback(conferences);
   });

   sel[0].selectize.on('change', function(v) {
      filtersel.disable();
      filtersel.clearOptions();
      filtersel.load(function(callback) {
         $.ajax({
            url: '/events/admin/crossmail/options/?conf=' + v,
            success: function(r) {
               callback(r);
               filtersel.$wrapper.show();
               if (current_default_filt) {
                  filtersel.setValue(current_default_filt);
                  current_default_filt = null;
               }
               filtersel.enable();
            },
            error: function() {
               callback();
            },
         });
      });
   });

   if (default_conf) {
      sel[0].selectize.setValue(default_conf);
   }

}

function addNewFilter(type) {
   add_conference_picker(type);
   return false;
}

function removeFilter(type, num) {
   var el = $('#' + type + 'wrap_' + num);
   el.remove();
}

function submit_form() {
   function collect(type) {
      var items = [];
      $('select[id^=' + type + '_]').each(function(i, e) {
         var conf = $(e).val();
         var filt = $('#' + e.id.replace('_', 't_')).val();
         if (conf != null && conf != '' && filt != null && filt != '') {
            items.push(conf + '@' + filt);
         }
      });
      $('#id_' + type).val(items.join(';'));
   }

   collect('include');
   collect('exclude');
}

$(function() {
   $('#id_attendees_of, #id_attendees_not_of').selectize({'plugins': ['remove_button']});


   function prepare_picker(type) {
      var e = $('#id_' + type);
      if (e.val()) {
         pickers = e.val().split(';');
         for (var p in pickers) {
            var pieces = pickers[p].split('@');
            add_conference_picker(type, pieces[0], pieces[1]);
         }
      } else {
         // Add an empty picker
         add_conference_picker(type);
      }
   }
   prepare_picker('include');
   prepare_picker('exclude');
});
</script>
{%endblock%}
{%block layoutblock%}
<h1>Conference Emails</h1>
<form method="post" action=".">{%csrf_token%}
<table class="mailform">
<tr>
  <th>Include</th>
  <td id="include_td">
    <button id="include_btn" class="btn btn-xs" style="float:left" onclick="return addNewFilter('include')"><span class="glyphicon glyphicon-plus-sign"></span></button>
  </td>
</tr>
<tr>
  <th>Exclude</th>
  <td id="exclude_td">
    <button id="exclude_btn" class="btn btn-xs" style="float:left" onclick="return addNewFilter('exclude')"><span class="glyphicon glyphicon-plus-sign"></span></button>
  </td>
</tr>
{{form.as_table}}
</table>
<input type="submit" value="Send mail" onClick="return submit_form()">
</form>
{%if recipients%}
<p>
Mail will be sent to the following {{recipients.all.count}} recipients:
</p>
<ul>
{%for r in recipients%} <li>{{r.fullname}} &lt;{{r.email}}&gt;</li>{%endfor%}
</ul>
{%endif%}
{%endblock%}
