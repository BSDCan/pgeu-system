{%extends "confreg/confadmin_base.html" %}
{%block title%}Create schedule{%endblock%}
{%block extrahead%}
<link rel="stylesheet" href="/media/jq/jquery-ui.min.css" />
<script type="text/javascript" src="/media/jq/jquery-ui.min.js"></script>
<style media="print">
#pgHeaderContainer, #pgSideWrap { display:none; }
div.schedwrap {
   font-size: 69%;
}
</style>
<style>
div.schedwrap {
   border: 1px solid black;
   position: relative;
}
div.sessblock {
   border: 1px solid gray;
   overflow:hidden;
   position: absolute;
}
div.sesspending {
   opacity: 0.3;
}
div.roomheader {
   font-weight: bold;
   font-size: 1.2em;
   top: 0px;
   text-align: center;
}
div.sessblock a {
   text-decoration: none;
   color: black;
}
div.actualsession {
   z-index: 10;
}
#assignMenu {
  position: absolute;
  display:none;
  z-index: 10000;
}

{%for track in tracks%}
div.track{{track.id}} {
   background-color: {{track.color}};
}
{%endfor%}
</style>

<script type="text/javascript">
$( init );
/* Yes, this is very full of ugly hacks */

function init() {
  var assignMenu = $('#assignMenu');

  $('.actualsession').draggable({
    cursor: 'move',
    snap: '.sessionslot',
    revert: 'invalid',
  });

  $('.sessionslot').droppable({
    drop: function(event, ui) {
     session = ui.draggable;

     // Are we moving away from existing slot? If so, mark it as open!
     if (session.attr('slot')) {
        oldslot = $('#' + session.attr('slot'));
        oldslot.attr('sessionid', null);
        oldslot.droppable('option', 'accept', '.actualsession');
     }

     $(this).attr('sessionid', session.attr('id'));
     session.attr('slot', $(this).attr('id'));

     // Since something is now in this slot, turn off the acceptableness
     $(this).droppable('option', 'accept', 'busy');

     // Align the position of our object
     session.css($(this).offset());
     session.height($(this).height());
     session.width($(this).width());
   }
  });

  $('#availablewrapper').droppable({
    drop: function(event, ui) {
      session = ui.draggable;
      // Are we moving away from existing slot? If so, mark it as open!
      if (session.attr('slot')) {
        oldslot = $('#' + session.attr('slot'));
        oldslot.attr('sessionid', null);
        oldslot.droppable('option', 'accept', '.actualsession');
        session.attr('slot', null);
      }
    }
  });

  $('.actualsession').contextmenu(function(e) {
      assignMenu.data('sourceid', this.id);
      assignMenu.css({
        display:"block",
        left: e.pageX,
        top: e.pageY
      });
      return(false);
  });
  assignMenu.on("click", "a", function() {
     assignMenu.hide();
     $('.assignSubMenu').hide();
  });
  $('body').click(function () {
     assignMenu.hide();
     $('.assignSubMenu').hide();
  });

  $('#assign_unassign').click(function(e) {
     var session = $('#' + assignMenu.data('sourceid'));
     /* Unassign the currently selected session, if it's scheduled */
     if (session.attr('slot')) {

        var openslot = -1;
        /* Find find the first available slot */
        for (var i = 0; i < {{sessions|length}}; i++) {
           var t = (i+2)*75 + 120;
           var found = false;
           $('div.actualsession').each(function(i, o) {
              var e = $(o);
              if (e.attr('slot')) {
                 return true;
              }
              if (e.position().top == t) {
                 found = true;
                 return false;
              }
           });
           if (!found) {
              openslot = i;
              break;
           }
        }
        if (openslot < 0) {
           alert('Unable to find open slot to reposition old item! Aborting! Sorry!');
           return;
        }

        oldslot = $('#' + session.attr('slot'));
        oldslot.attr('sessionid', null);
        oldslot.droppable('option', 'accept', '.actualsession');
        session.attr('slot', null);
        session.css({
           'top': (openslot + 2)*75 + 120,
           'left': $('#availablewrapper').position().left,
           'height': 75,
           'width': {{sesswidth}}
        });
      }
      else
         alert('This session is not assigned to a slot');
  });

  $('.assignMenuTimeslot').click(function(e) {
     var slotid = $(this).data('slotid');
     var slot = $('#slot' + slotid);
     var session = $('#' + assignMenu.data('sourceid'));

     if (slot.attr('sessionid')) {
        alert('A session is already assigned to this slot. Unassign that one first.');
     }
     else {
        // Are we moving away from existing slot? If so, mark it as open!
        if (session.attr('slot')) {
           oldslot = $('#' + session.attr('slot'));
           oldslot.attr('sessionid', null);
           oldslot.droppable('option', 'accept', '.actualsession');
        }

        slot.attr('sessionid', session.attr('id'));
        session.attr('slot', slotid);

        slot.droppable('option', 'accept', 'busy');

        // Update the position as necessary
        session.css(slot.offset());
        session.height(slot.height());
        session.width(slot.width());
     }

     assignMenu.hide();
     $('.assignSubMenu').hide();
  });

/* Fix for submenus */
  $('ul.dropdown-menu [data-toggle=dropdown]').on('click', function (event) {
     $(this).parent().siblings('.dropdown-submenu').each(function(i, o) {
        $(o).find('ul.dropdown-menu').hide();
     });
  });
/* End of fix for submenus */

  $('#loaderDiv')
     .hide()
     .ajaxStart(function() { $(this).show(); })
     .ajaxStop(function() { $(this).hide(); })
  ;

  // Load the current state
  $.get('.?get=1', function(data) {
     $.each(data, function(k, v) {
        slot = $('#' + k);
        session = $('#' + v);
        slot.attr('sessionid', session.attr('id'));
        session.attr('slot', slot.attr('id'));

        // Since something is now in this slot, turn off the acceptableness
        slot.droppable('option', 'accept', 'busy');

        // Align the position of our object
        session.css(slot.offset());
        session.height(slot.height());
        session.width(slot.width());
     });
  });
}

function saveDraft() {
   if (!confirm("Are you sure you want to save the draft? (This overwrites all changes, but doesn't publish anything)")) {
      return;
   }
   // Build a representation of all scheduled slots
   sched = {
      'csrfmiddlewaretoken': '{{csrf_token}}',
   }
   $('.sessionslot').each(function(i, el) {
      sessionid = $(el).attr('sessionid');
      if (sessionid) {
         sched[$(el).attr('id')] = sessionid;
      }
   });
   $.post('.', sched, function(data) {
      alert('Saved.');
   }).error(function(data) {
      alert('Failed!\n' + data);
   });
}
</script>
{%endblock%}

{%block layoutblock%}
<h1>Create Conference Schedule - {{conference}}</h1>
<p>
<b>NOTE! THIS IS FOR CREATING A TENTATIVE SCHEDULE ONLY!</b>
You also have to manually verify that the length of the talk matches
the talk slot, if your schedule supports multiple different lengths.
</p>

<div id="loaderDiv" style="background-color: gray; position:absolute; z-index:9999; top:0; left:0; width:100%; height:100%; opacity: .5;text-align:center;">
  <font size="30">Please wait, talking to Mr Server...</font>
</div>

<div id="availablewrapper" style="float:right; border:1px solid blue;width:{{sesswidth}}px;height:{{availableheight}}px; margin-top: 0px;">
  <h3>Available sessions</h3> 
  {%for s in sessions %}
   <div id="sess{{s.id}}" class="sessblock actualsession track{{s.track_id}}{%if s.ispending%} sesspending{%endif%}" style="top: {{s.top|add:"120"}}px; width: {{sesswidth}}px; height: 75px;">{{s.title}}<br/><i>{{s.speaker_list}}</i></div>
  {%endfor%}
</div>

{%for day in days%}
<h2>{{day.day|date:"l, F d"}}</h2>
<div class="schedwrap" style="height: {{day.schedule_height}}px; width: {{day.schedule_width}}px;">
{%for room in day.rooms%}
 <div class="sessblock roomheader" style="left: {{room.leftpos}}px; width: {{room.widthpos}}px; height: {{room.heightpos}}px;" title="{{room.comment}}">
 {{room.name}}
 </div>
{%endfor%}
{%for session in day.sessions%}
  <div id="slot{{session.id}}" class="sessblock sessionslot" style="top: {{session.toppos}}px; left: {{session.leftpos}}px; width: {{session.widthpos}}px; height: {{session.heightpos}}px;">
  {{session.timeslot}}
</div>
{%endfor%}
</div>

{%endfor%}
<button onClick="saveDraft()" class="btn btn-default">Save draft</button>
<p>
When you are ready to publish, click <a href="publish/" class="btn btn-default btn-xs">here</a>. (you must
save using the standard save button first, of course)
</p>

<a class="btn btn-default btn-block" href="/events/admin/{{conference.urlname}}/">Back to dashboard</a>

<div id="assignMenu" class="dropdown clearfix">
  <ul class="dropdown-menu" role="menu" style="display:block;position:static;margin-bottom:5px;">
    <li class="dropdown-header">Assign session</li>
    <li><a href="#" id="assign_unassign">Unassign</a></li>
    <div class="dropdown-divider"></div>
    <li role="separator" class="divider"></li>
{%for day in days %}
    <li class="dropdown-submenu">
    <a href="#" data-toggle="dropdown">{{day.day|date:"l, F d"}} <span class="glyphicon glyphicon-chevron-right"></span></a>
      <ul class="dropdown-menu assignSubMenu">
{%for room in day.rooms %}
        <li class="dropdown-submenu">
          <a href="#" data-toggle="dropdown">{{room.name}} <span class="glyphicon glyphicon-chevron-right"></span></a>
	  <ul class="dropdown-menu assignSubMenu">
{%for session in day.sessions %}
{%if session.room_id == room.id %}
            <li><a href="#" class="assignMenuTimeslot" data-slotid="{{session.id}}">{{session.timeslot}}</a></li>
{%endif%}
{%endfor%}
	  </ul>
	</li>
{%endfor%}
      </ul>
    </li>
{%endfor%}
  </ul>
</div>
{%endblock%}
