{%extends "confreg/confadmin_base.html" %}
{%load markup%}
{%block title%}Vote for sessions{%endblock%}
{%block extrahead%}
<link rel="stylesheet" href="/media/jq/jquery-ui.min.css" />
<script type="text/javascript" src="/media/jq/jquery-ui.min.js"></script>

<script type="text/javascript">
$(function() {
  $('.dlg').each(function(idx, el) {
    $(el).dialog({
      autoOpen: false,
      minWidth: 400,
      minHeight: 250,
      height: 600,
    });
  });

  $('#dlgStatus').dialog({
     autoOpen: false,
     modal: true,
     resizable: false,
  });

  $('#ajaxStatus').hide();
});

function showDialog(id, title) {
   if ($('#popup_' + id).dialog('isOpen')) {
      $('#popup_' + id).dialog('close');
   } else {
      $('#popup_' + id).dialog('option', {
         'title': title,
      }).dialog('open');
   }
}

var buttonoptions = {
{%for o in status_choices%}
   {{o.0}}: '{{o.1}}',
{%endfor%}
};
var buttonoptions_reverse = {
{%for o in status_choices%}
   '{{o.1}}': {{o.0}},
{%endfor%}
};

function doUpdateStatus(id, statustext) {
   statusval = buttonoptions_reverse[statustext];
   $.post('changestatus/',
      {
         'csrfmiddlewaretoken': '{{csrf_token}}',
         'sessionid': id,
         'newstatus': statusval,
      },
      function(data) {
         var pieces = data.split(';');
         $('#ajaxStatus').text('Changed status to ' + pieces[0]).fadeIn(500).delay(1000).fadeOut(500);
         $('#statusstr' + id).text(pieces[0]).css('background-color', pieces[1]=='1'?'yellow':'white');
      }
   ).fail(function() {
      alert('AJAX call failed');
   });
}

function changeStatus(id) {
   var currentstatus = buttonoptions_reverse[$('#statusstr' + id).text()];
   var buttons = {};
   for (var k in buttonoptions) {
      if (k != currentstatus && k != 1) {
         buttons[buttonoptions[k]] = function(event) {
            doUpdateStatus(id, $(event.target).text());
            $(this).dialog("close");
         };
      }
   }
   buttons['Cancel'] = function() {
           $( this ).dialog( "close" );
   };

   $('#dlgStatus').dialog('option', {
      'title': 'Change status',
      'modal': true,
   }).dialog('option', {
     buttons: buttons,
   }).dialog('open');
}
</script>
<style>
td.dlgClickable {
  cursor: pointer;
}
div.dlg {
  display: none;
}

/* Override bootstrap to make full screen */
.container {
width: 100%;
}
</style>
{%endblock%}
{%block layoutblock%}
<h1>Vote for sessions - {{conference}}</h1>

<div id="ajaxStatus" class="alert alert-success" style="position: fixed; width: 100%;opacity: .8; text-align: center; font-weight: bold; font-size: 1.2em;">Nothing Yet</div>

<form method="post" action=".">{% csrf_token %}
<table class="table table-bordered table-condensed">
 <tr>
  <th><a href="?sort=session">Session</a> | <a href="?sort=speakers">Speakers</a></th>
  <th>Status</th>
  {%for u in users%}
  <th>{{u}}</th>
  {%endfor%}
  <th><a href="?sort=avg">Average</a></th>
  <th>Your comments</th>
  <th>Other comments</th>
 </tr>
{%for s in sessionvotes%}
 <tr>
   <td onClick="showDialog({{s.id}}, '{{s.title|escape|escapejs|escape}}')" class="dlgClickable">{{s.title}} ({{s.speakers}})
    <div id="popup_{{s.id}}" class="dlg">
    <div><strong>Speakers:</strong> {{s.speakers_full}}</div>
    <div><strong>Track:</strong> {{s.track}}</div>
    <p>
{{s.abstract}}
    </p>
{%if s.submissionnote%}
    <hr/>
    <h3>Submission notes</h3>
    <p>
{{s.submissionnote}}
    </p>
{%endif%}
    <hr/>
    <h3>Speaker profile</h3>
    <p>
{{s.speakers_long|markdown}}
    </p>
    </div>
   </td>
   {%if isadmin%}
   <td{%if not s.statusid == s.laststatusid %} bgcolor="yellow"{%endif%} onClick="changeStatus({{s.id}})" class="dlgClickable" id="statusstr{{s.id}}">{{s.status}}</td>
{%else%}
   <td>{{s.status}}</td>
{%endif%}
   {%for u in s.users%}
   <td{%if u|default_if_none:0 == 0%} style="background-color:red"{%endif%}>{%if forloop.first %}
     <select name="sv_{{s.id}}">
       {%for opt in "0123456789"|make_list%}
       <option value="{{opt}}"{%if opt|add:0 == u|add:0%} SELECTED{%endif%}>{{opt}}</option>
       {%endfor%}
     </select>
     {%else%}
     {{u|default_if_none:''}}
     {%endif%}
   </td>
   {%endfor%}
   <td>{{s.avg|default_if_none:''}}</td>
   <td><input type="text" name="tc_{{s.id}}" maxlength="200" value="{{s.owncomment}}"/></td>
   <td>{{s.comments|safe}}</td>
 </tr>
{%endfor%}
</table>
<input type="submit" value="Save">
</form>
{%if isadmin and conference.pending_session_notifications%}
<h2>Notifications</h2>
<p>
  There are pending
  <a href="/events/{{conference.urlname}}/sessionnotifyqueue/">session notifications</a>
  to be sent!
</p>
{%endif%}

<div id="dlgStatus">
</div>

{%endblock%}
